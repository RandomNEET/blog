---
title: Switch to niri
published: 2025-10-21
description: Notes on setting up niri on NixOS (and the issues I ran into)
tags: [Daily, niri, NixOS]
category: Daily
draft: false
---

# XDG Desktop Portal

Here is my XDG Desktop Portal config with home-manager:

```nix
xdg = {
  enable = true;
  portal = {
    enable = true;
    xdgOpenUsePortal = true;
    extraPortals = with pkgs; [ xdg-desktop-portal-gtk ];
    configPackages = [ pkgs.xdg-desktop-portal-gtk ];
    config.common.default = "gtk";
  };
};
```

Initially, the xdg-desktop-portal.service kept failing to start. The logs below show the issue:

```log
× xdg-desktop-portal.service - Portal service
     Loaded: loaded (/etc/systemd/user/xdg-desktop-portal.service; linked-runtime; preset: ignored)
     Active: failed (Result: timeout) since Mon 2025-10-20 17:03:41 CST; 27s ago
 Invocation: 61d08de34f8f4e20941fd724aa8cef22
    Process: 4125 ExecStart=/nix/store/filqr58p5npllvq9zr6zl4rpy8nfx63r-xdg-desktop-portal-1.20.3/libexec/xdg-desktop-portal (code=killed, signal=TERM)
   Main PID: 4125 (code=killed, signal=TERM)
   Mem peak: 6.6M
        CPU: 57ms

Oct 20 17:02:11 lix systemd[4000]: Starting Portal service...
Oct 20 17:03:01 lix .xdg-desktop-po[4125]: Failed to create settings proxy: Error calling StartServiceByName for org.freedesktop.impl.portal.desktop.gtk: T>
Oct 20 17:03:01 lix .xdg-desktop-po[4125]: No skeleton to export
Oct 20 17:03:26 lix .xdg-desktop-po[4125]: Failed to create file chooser proxy: Error calling StartServiceByName for org.freedesktop.impl.portal.desktop.gt>
Oct 20 17:03:26 lix .xdg-desktop-po[4125]: No skeleton to export
Oct 20 17:03:41 lix systemd[4000]: xdg-desktop-portal.service: start operation timed out. Terminating.
Oct 20 17:03:41 lix systemd[4000]: xdg-desktop-portal.service: Failed with result 'timeout'.
Oct 20 17:03:41 lix systemd[4000]: Failed to start Portal service.
```

The failure was likely due to missing environment variables. After adding `spawn-sh-at-startup "dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=gnome"` to niri’s config.kdl, the xdg-desktop-portal.service was able to start normally.However, xdg-open still didn’t work.
According to [niri's wiki](https://yalter.github.io/niri/Important-Software.html#portals), portals require running niri as a session.
I had previously launched `niri` directly from TTY; starting it via the `niri-session` command made xdg-open work properly.

# Swayidle

Swayidle could not find the commands defined in the configuration below:

```nix
 services.swayidle = {
        enable = true;
        events = [
          {
            event = "lock";
            command = "pidof swaylock || swaylock";
          }
          {
            event = "unlock";
            command = "pkill --signal SIGUSR1 swaylock";
          }
          {
            event = "before-sleep";
            command = "loginctl lock-session";
          }
          {
            event = "after-resume";
            command = "niri msg action power-on-monitors";
          }
        ];
        timeouts = [
            {
              timeout = 300;
              command = "pidof swaylock || swaylock";
            }
            {
              timeout = 1800;
              command = "niri msg action power-off-monitors";
              resumeCommand = "niri msg action power-on-monitors";
            }
            {
              timeout = 3600;
              command = "systemctl hibernate";
            }
        ];
      };
```

The commands worked, but the monitors were only turned off after I unlocked swaylock, because swaylock blocks subsequent commands while it is running.

```nix
 services.swayidle = {
        enable = true;
        events = [
          {
            event = "lock";
            command = "${pkgs.procps}/bin/pidof swaylock || ${pkgs.swaylock}/bin/swaylock";
          }
          {
            event = "unlock";
            command = "${pkgs.procps}/bin/pkill --signal SIGUSR1 swaylock";
          }
          {
            event = "before-sleep";
            command = "${pkgs.systemd}/bin/loginctl lock-session";
          }
          {
            event = "after-resume";
            command = "${pkgs.niri}/bin/niri msg action power-on-monitors";
          }
        ];
        timeouts = [
            {
              timeout = 300;
              command = "${pkgs.systemd}/bin/loginctl lock-session";
            }
            {
              timeout = 1800;
              command = "${pkgs.niri}/bin/niri msg action power-off-monitors";
              resumeCommand = "${pkgs.niri}/bin/niri msg action power-on-monitors";
            }
            {
              timeout = 3600;
              command = "${pkgs.systemd}/bin/systemctl hibernate";
            }
        ];
      };
```

Running swaylock in the background fixes the blocking issue.

```nix
 services.swayidle = {
        enable = true;
        events = [
          {
            event = "lock";
            command = "${pkgs.swaylock}/bin/swaylock &";
          }
          {
            event = "unlock";
            command = "${pkgs.procps}/bin/pkill --signal SIGUSR1 swaylock";
          }
          {
            event = "before-sleep";
            command = "${pkgs.systemd}/bin/loginctl lock-session";
          }
          {
            event = "after-resume";
            command = "${pkgs.niri}/bin/niri msg action power-on-monitors";
          }
        ];
        timeouts = [
            {
              timeout = 300;
              command = "${pkgs.systemd}/bin/loginctl lock-session";
            }
            {
              timeout = 1800;
              command = "${pkgs.niri}/bin/niri msg action power-off-monitors";
              resumeCommand = "${pkgs.niri}/bin/niri msg action power-on-monitors";
            }
            {
              timeout = 3600;
              command = "${pkgs.systemd}/bin/systemctl hibernate";
            }
        ];
      };
```

# Swaybg

Add the config below to place swaybg inside the overview backdrop so that the wallpaper won’t move along with the workspaces.

```kdl
layer-rule {
    match namespace="^wallpaper$"
    place-within-backdrop true
}
```

# Waybar

According to [niri's wiki](https://yalter.github.io/niri/Layer%E2%80%90Shell-Components.html), waybar should be on the top layer, but it appeared on the bottom layer:

```log
~ niri msg layers
Output "eDP-1":
  Background layer:
    Surface:
      Namespace: "swww-daemon"
      Keyboard interactivity: none

  Bottom layer:
    Surface:
      Namespace: "waybar"
      Keyboard interactivity: none

  Top layer: (empty)

  Overlay layer: (empty)
```

After removing `mode = "dock";` from waybar’s config, it now appears on the correct layer.

# Xwayland

Niri integrates with xwayland-satellite out of the box. Add `home.packages = with pkgs; [ xwayland-satellite ];` or `environment.systemPackages = with pkgs; [ xwayland-satellite ];` in configuration.nix to install it.

# Steam

See [Steam shows as a black screen](https://github.com/YaLTeR/niri/issues/1034).
